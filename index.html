<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Chat Cleaner & Editor</title>
    <!-- JSZip for handling zip files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver.js for downloading files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --whatsapp-green: #128C7E;
            --whatsapp-teal: #075E54;
            --whatsapp-light: #ECE5DD;
            --whatsapp-chat-bg: #E5DDD5;
            --whatsapp-sent: #DCF8C6;
            --whatsapp-received: #FFFFFF;
            --delete-red: #FF5252;
            --success-green: #25D366;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #f0f0f0;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, var(--whatsapp-teal), var(--whatsapp-green));
            color: white;
            padding: 24px 32px;
            text-align: center;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .app-icon {
            width: 48px;
            height: 48px;
            margin-right: 16px;
            vertical-align: middle;
            background-color: white;
            border-radius: 12px;
            padding: 8px;
        }

        main {
            display: flex;
            flex-direction: column;
            padding: 24px;
            gap: 24px;
        }

        .upload-section, .chat-section, .export-section {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        h2 {
            color: var(--whatsapp-teal);
            margin-bottom: 16px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2 i {
            font-size: 24px;
        }

        .instructions {
            background-color: var(--whatsapp-light);
            border-left: 4px solid var(--whatsapp-green);
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }

        .instructions h3 {
            color: var(--whatsapp-teal);
            margin-bottom: 8px;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .file-upload-area {
            border: 2px dashed var(--whatsapp-green);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background-color: rgba(18, 140, 126, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            background-color: rgba(18, 140, 126, 0.1);
            border-color: var(--whatsapp-teal);
        }

        .file-upload-area i {
            font-size: 48px;
            color: var(--whatsapp-green);
            margin-bottom: 16px;
        }

        .file-upload-area p {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .file-upload-area small {
            color: #666;
        }

        #fileInput {
            display: none;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            background-color: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--whatsapp-green);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .chat-container {
            background-color: var(--whatsapp-chat-bg);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cpath fill='%23d1ccc7' fill-opacity='0.2' d='M0 0h50v50H0V0zm50 50h50v50H50V50z'/%3E%3C/svg%3E");
            border-radius: 10px;
            height: 500px;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.received {
            background-color: var(--whatsapp-received);
            align-self: flex-start;
            border-top-left-radius: 4px;
        }

        .message.sent {
            background-color: var(--whatsapp-sent);
            align-self: flex-end;
            border-top-right-radius: 4px;
        }

        .message.deleted {
            opacity: 0.5;
            background-color: #f8f8f8;
            border: 1px dashed #ccc;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .sender {
            font-weight: bold;
            color: var(--whatsapp-teal);
        }

        .timestamp {
            color: #999;
            font-size: 12px;
        }

        .message-content {
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .delete-btn {
            background-color: var(--delete-red);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 6px 14px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
        }

        .delete-btn:hover {
            background-color: #ff3333;
        }

        .restore-btn {
            background-color: #666;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 6px 14px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
        }

        .restore-btn:hover {
            background-color: #555;
        }

        .media-preview {
            margin-top: 10px;
            max-width: 200px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .media-preview img, .media-preview video {
            width: 100%;
            display: block;
        }

        .media-placeholder {
            background-color: #f0f0f0;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .export-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--whatsapp-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--whatsapp-teal);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(7, 94, 84, 0.3);
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .progress-bar {
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            margin-top: 16px;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--whatsapp-green);
            width: 0%;
            transition: width 0.3s;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #ddd;
        }

        @media (max-width: 768px) {
            main {
                padding: 16px;
            }
            
            .upload-section, .chat-section, .export-section {
                padding: 16px;
            }
            
            .chat-container {
                height: 400px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .export-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .stats-bar {
                flex-wrap: wrap;
            }
            
            .stat-item {
                flex: 0 0 50%;
                margin-bottom: 16px;
            }
        }

        /* Icon styles using Unicode characters */
        .icon {
            font-style: normal;
            display: inline-block;
        }
        
        .icon-upload::before { content: "üì§"; }
        .icon-chat::before { content: "üí¨"; }
        .icon-download::before { content: "üì•"; }
        .icon-delete::before { content: "üóëÔ∏è"; }
        .icon-restore::before { content: "‚Ü©Ô∏è"; }
        .icon-whatsapp::before { content: "üü¢"; }
        .icon-file::before { content: "üìÅ"; }
        .icon-image::before { content: "üñºÔ∏è"; }
        .icon-video::before { content: "üé•"; }
        .icon-audio::before { content: "üéµ"; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span class="icon icon-whatsapp"></span> WhatsApp Chat Cleaner & Editor</h1>
            <p class="subtitle">Upload, edit, and export cleaned WhatsApp chat archives</p>
        </header>
        
        <main>
            <section class="upload-section">
                <h2><span class="icon icon-upload"></span> 1. Upload WhatsApp ZIP</h2>
                
                <div class="instructions">
                    <h3>How to export your WhatsApp chat:</h3>
                    <ol>
                        <li>Open the WhatsApp chat you want to export</li>
                        <li>Tap on More options ‚Üí Export chat</li>
                        <li>Choose "WITHOUT MEDIA" or "INCLUDE MEDIA"</li>
                        <li>Share the exported ZIP file to your computer</li>
                    </ol>
                </div>
                
                <div class="file-upload-area" id="dropZone">
                    <div class="icon icon-upload"></div>
                    <p>Drag & drop your WhatsApp ZIP file here</p>
                    <p>or</p>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <span class="icon icon-file"></span> Browse Files
                    </button>
                    <input type="file" id="fileInput" accept=".zip">
                    <p><small>Only WhatsApp exported ZIP files are supported</small></p>
                </div>
                
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </section>
            
            <section class="chat-section">
                <h2><span class="icon icon-chat"></span> 2. View & Edit Chat</h2>
                
                <div class="stats-bar" id="statsBar" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-value" id="totalMessages">0</div>
                        <div class="stat-label">Total Messages</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="remainingMessages">0</div>
                        <div class="stat-label">Remaining</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="deletedMessages">0</div>
                        <div class="stat-label">Deleted</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="mediaFiles">0</div>
                        <div class="stat-label">Media Files</div>
                    </div>
                </div>
                
                <div class="chat-container" id="chatContainer">
                    <div class="empty-state" id="emptyState">
                        <div class="icon icon-chat"></div>
                        <p>Upload a WhatsApp ZIP file to view the chat</p>
                    </div>
                </div>
            </section>
            
            <section class="export-section">
                <h2><span class="icon icon-download"></span> 3. Export Cleaned Chat</h2>
                
                <div class="export-actions">
                    <button class="btn btn-secondary" id="clearAllBtn" disabled onclick="clearAllMessages()">
                        <span class="icon icon-delete"></span> Clear All Messages
                    </button>
                    <button class="btn btn-secondary" id="restoreAllBtn" disabled onclick="restoreAllMessages()">
                        <span class="icon icon-restore"></span> Restore All
                    </button>
                    <button class="btn btn-primary" id="exportBtn" disabled onclick="exportCleanedZip()">
                        <span class="icon icon-download"></span> Download Cleaned ZIP
                    </button>
                </div>
                
                <div class="progress-bar" id="exportProgressBar">
                    <div class="progress-fill" id="exportProgressFill"></div>
                </div>
            </section>
        </main>
        
        <footer>
            <p>This tool runs entirely in your browser. Your data never leaves your computer.</p>
            <p>Works with both Android and iOS WhatsApp export formats</p>
        </footer>
    </div>

    <script>
        // Global state
        const state = {
            messages: [],
            mediaFiles: new Map(), // filename -> blob
            chatFileName: '_chat.txt',
            isFileLoaded: false
        };

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const chatContainer = document.getElementById('chatContainer');
        const emptyState = document.getElementById('emptyState');
        const statsBar = document.getElementById('statsBar');
        const exportBtn = document.getElementById('exportBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const restoreAllBtn = document.getElementById('restoreAllBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const exportProgressBar = document.getElementById('exportProgressBar');
        const exportProgressFill = document.getElementById('exportProgressFill');

        // Statistics elements
        const totalMessagesEl = document.getElementById('totalMessages');
        const remainingMessagesEl = document.getElementById('remainingMessages');
        const deletedMessagesEl = document.getElementById('deletedMessages');
        const mediaFilesEl = document.getElementById('mediaFiles');

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--whatsapp-teal)';
                dropZone.style.backgroundColor = 'rgba(18, 140, 126, 0.1)';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = 'var(--whatsapp-green)';
                dropZone.style.backgroundColor = 'rgba(18, 140, 126, 0.05)';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--whatsapp-green)';
                dropZone.style.backgroundColor = 'rgba(18, 140, 126, 0.05)';
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect();
                }
            });
        });

        // Handle file selection
        async function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file || !file.name.endsWith('.zip')) {
                alert('Please select a valid ZIP file exported from WhatsApp.');
                return;
            }
            
            // Reset state
            state.messages = [];
            state.mediaFiles.clear();
            state.isFileLoaded = false;
            
            // Show progress
            progressBar.style.display = 'block';
            progressFill.style.width = '10%';
            
            try {
                // Read the ZIP file
                const zip = await JSZip.loadAsync(file);
                progressFill.style.width = '30%';
                
                // Find the chat file (could be _chat.txt or named differently)
                let chatFile = null;
                for (const filename in zip.files) {
                    if (filename.includes('chat') && filename.endsWith('.txt')) {
                        chatFile = zip.files[filename];
                        state.chatFileName = filename;
                        break;
                    }
                }
                
                if (!chatFile) {
                    throw new Error('No chat file found in the ZIP archive.');
                }
                
                // Parse the chat file
                const chatText = await chatFile.async('text');
                progressFill.style.width = '50%';
                
                // Parse messages
                const messages = parseChatText(chatText);
                
                // Extract media files from ZIP
                let mediaCount = 0;
                for (const filename in zip.files) {
                    const file = zip.files[filename];
                    if (!file.dir) {
                        // Check if it's a media file (image, video, audio)
                        const ext = filename.split('.').pop().toLowerCase();
                        const isMedia = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'mp4', 'avi', 'mov', 'mp3', 'm4a', 'ogg', 'opus'].includes(ext);
                        
                        if (isMedia) {
                            const blob = await file.async('blob');
                            state.mediaFiles.set(filename, blob);
                            mediaCount++;
                        }
                    }
                }
                
                progressFill.style.width = '80%';
                
                // Map media files to messages
                messages.forEach(msg => {
                    if (msg.mediaName) {
                        // Try to find the media file
                        for (const [filename] of state.mediaFiles.entries()) {
                            if (filename.includes(msg.mediaName) || msg.mediaName.includes(filename)) {
                                msg.mediaBlob = state.mediaFiles.get(filename);
                                msg.mediaFilename = filename;
                                break;
                            }
                        }
                    }
                });
                
                // Update state
                state.messages = messages;
                state.isFileLoaded = true;
                
                // Update UI
                renderChat();
                updateStats();
                
                // Hide progress bar
                setTimeout(() => {
                    progressFill.style.width = '100%';
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        progressFill.style.width = '0%';
                    }, 500);
                }, 300);
                
            } catch (error) {
                console.error('Error processing ZIP file:', error);
                alert('Error processing the ZIP file. Please make sure it is a valid WhatsApp export.');
                progressBar.style.display = 'none';
            }
        }

        // Parse chat text into message objects
        function parseChatText(chatText) {
            const lines = chatText.split('\n');
            const messages = [];
            
            // Regular expressions for different WhatsApp formats
            const androidPattern = /^(\d{1,2}\/\d{1,2}\/\d{2,4}),?\s(\d{1,2}:\d{2}(?::\d{2})?)\s(?:[ap]m)?\s*-\s*([^:]+):\s*(.+)$/i;
            const iosPattern = /^\[(\d{1,2}\/\d{1,2}\/\d{2,4}),?\s(\d{1,2}:\d{2}(?::\d{2})?)\]\s*([^:]+):\s*(.+)$/i;
            
            let currentMessage = null;
            
            lines.forEach((line, index) => {
                line = line.trim();
                if (!line) return;
                
                // Check for Android format
                let match = line.match(androidPattern);
                let format = 'android';
                
                // If not Android, check for iOS format
                if (!match) {
                    match = line.match(iosPattern);
                    format = 'ios';
                }
                
                if (match) {
                    // This is a new message
                    if (currentMessage) {
                        messages.push(currentMessage);
                    }
                    
                    const [, date, time, sender, content] = match;
                    const mediaMatch = content.match(/(.+?)\s*\(file attached\)$/);
                    
                    currentMessage = {
                        id: `msg-${Date.now()}-${index}`,
                        originalLine: line,
                        date,
                        time,
                        timestamp: `${date} ${time}`,
                        sender: sender.trim(),
                        content: mediaMatch ? mediaMatch[1] : content,
                        mediaName: mediaMatch ? mediaMatch[1].trim() : null,
                        mediaBlob: null,
                        mediaFilename: null,
                        deleted: false,
                        format
                    };
                } else if (currentMessage) {
                    // This line is a continuation of the previous message
                    currentMessage.content += '\n' + line;
                    currentMessage.originalLine += '\n' + line;
                }
            });
            
            // Add the last message
            if (currentMessage) {
                messages.push(currentMessage);
            }
            
            return messages;
        }

        // Render chat messages to the UI
        function renderChat() {
            if (!state.isFileLoaded || state.messages.length === 0) {
                emptyState.style.display = 'block';
                chatContainer.innerHTML = '';
                chatContainer.appendChild(emptyState);
                return;
            }
            
            emptyState.style.display = 'none';
            statsBar.style.display = 'flex';
            
            // Clear container
            chatContainer.innerHTML = '';
            
            // Add messages
            state.messages.forEach(msg => {
                const messageEl = createMessageElement(msg);
                chatContainer.appendChild(messageEl);
            });
            
            // Enable buttons
            exportBtn.disabled = false;
            clearAllBtn.disabled = false;
            restoreAllBtn.disabled = state.messages.every(m => !m.deleted);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Create a DOM element for a message
        function createMessageElement(msg) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${msg.sender === 'You' || msg.sender.includes('Me') ? 'sent' : 'received'} ${msg.deleted ? 'deleted' : ''}`;
            messageEl.id = msg.id;
            
            // Create message header
            const headerEl = document.createElement('div');
            headerEl.className = 'message-header';
            
            const senderEl = document.createElement('span');
            senderEl.className = 'sender';
            senderEl.textContent = msg.sender;
            
            const timestampEl = document.createElement('span');
            timestampEl.className = 'timestamp';
            timestampEl.textContent = msg.timestamp;
            
            headerEl.appendChild(senderEl);
            headerEl.appendChild(timestampEl);
            
            // Create message content
            const contentEl = document.createElement('div');
            contentEl.className = 'message-content';
            
            // Check if content is a media reference
            if (msg.mediaName) {
                contentEl.textContent = msg.mediaName;
                
                // Add media preview if available
                if (msg.mediaBlob) {
                    const mediaContainer = document.createElement('div');
                    mediaContainer.className = 'media-preview';
                    
                    const url = URL.createObjectURL(msg.mediaBlob);
                    
                    if (msg.mediaName.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = msg.mediaName;
                        mediaContainer.appendChild(img);
                    } else if (msg.mediaName.match(/\.(mp4|avi|mov|webm)$/i)) {
                        const video = document.createElement('video');
                        video.src = url;
                        video.controls = true;
                        video.preload = "metadata";
                        mediaContainer.appendChild(video);
                    } else if (msg.mediaName.match(/\.(mp3|m4a|ogg|opus|wav)$/i)) {
                        const audio = document.createElement('audio');
                        audio.src = url;
                        audio.controls = true;
                        mediaContainer.appendChild(audio);
                    } else {
                        const placeholder = document.createElement('div');
                        placeholder.className = 'media-placeholder';
                        placeholder.innerHTML = `<span class="icon icon-file"></span><p>${msg.mediaName}</p>`;
                        mediaContainer.appendChild(placeholder);
                    }
                    
                    contentEl.appendChild(mediaContainer);
                    
                    // Clean up URL when element is removed
                    messageEl.addEventListener('DOMNodeRemoved', () => {
                        URL.revokeObjectURL(url);
                    });
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'media-placeholder';
                    placeholder.innerHTML = `<span class="icon icon-file"></span><p>Media file not found in ZIP: ${msg.mediaName}</p>`;
                    contentEl.appendChild(placeholder);
                }
            } else {
                contentEl.textContent = msg.content;
            }
            
            // Create action buttons
            const actionsEl = document.createElement('div');
            actionsEl.className = 'message-actions';
            
            const actionBtn = document.createElement('button');
            if (msg.deleted) {
                actionBtn.className = 'restore-btn';
                actionBtn.innerHTML = '<span class="icon icon-restore"></span> Restore';
                actionBtn.onclick = () => toggleMessageDelete(msg.id, false);
            } else {
                actionBtn.className = 'delete-btn';
                actionBtn.innerHTML = '<span class="icon icon-delete"></span> Delete';
                actionBtn.onclick = () => toggleMessageDelete(msg.id, true);
            }
            
            actionsEl.appendChild(actionBtn);
            
            // Assemble message element
            messageEl.appendChild(headerEl);
            messageEl.appendChild(contentEl);
            messageEl.appendChild(actionsEl);
            
            return messageEl;
        }

        // Toggle message deletion state
        function toggleMessageDelete(messageId, shouldDelete) {
            const messageIndex = state.messages.findIndex(m => m.id === messageId);
            if (messageIndex === -1) return;
            
            state.messages[messageIndex].deleted = shouldDelete;
            
            // Update UI
            const messageEl = document.getElementById(messageId);
            if (messageEl) {
                messageEl.classList.toggle('deleted', shouldDelete);
                
                // Update button
                const actionBtn = messageEl.querySelector('.message-actions button');
                if (shouldDelete) {
                    actionBtn.className = 'restore-btn';
                    actionBtn.innerHTML = '<span class="icon icon-restore"></span> Restore';
                    actionBtn.onclick = () => toggleMessageDelete(messageId, false);
                } else {
                    actionBtn.className = 'delete-btn';
                    actionBtn.innerHTML = '<span class="icon icon-delete"></span> Delete';
                    actionBtn.onclick = () => toggleMessageDelete(messageId, true);
                }
            }
            
            updateStats();
            restoreAllBtn.disabled = state.messages.every(m => !m.deleted);
        }

        // Clear all messages
        function clearAllMessages() {
            if (!state.isFileLoaded) return;
            
            if (confirm('Are you sure you want to delete all messages? This cannot be undone.')) {
                state.messages.forEach(msg => {
                    msg.deleted = true;
                });
                
                renderChat();
                updateStats();
                restoreAllBtn.disabled = false;
            }
        }

        // Restore all messages
        function restoreAllMessages() {
            if (!state.isFileLoaded) return;
            
            state.messages.forEach(msg => {
                msg.deleted = false;
            });
            
            renderChat();
            updateStats();
            restoreAllBtn.disabled = true;
        }

        // Update statistics
        function updateStats() {
            if (!state.isFileLoaded) return;
            
            const total = state.messages.length;
            const deleted = state.messages.filter(m => m.deleted).length;
            const remaining = total - deleted;
            const mediaCount = Array.from(state.mediaFiles.keys()).length;
            
            totalMessagesEl.textContent = total;
            deletedMessagesEl.textContent = deleted;
            remainingMessagesEl.textContent = remaining;
            mediaFilesEl.textContent = mediaCount;
        }

        // Export cleaned ZIP file
        async function exportCleanedZip() {
            if (!state.isFileLoaded) return;
            
            // Show export progress
            exportProgressBar.style.display = 'block';
            exportProgressFill.style.width = '10%';
            
            try {
                // Filter out deleted messages
                const remainingMessages = state.messages.filter(m => !m.deleted);
                
                if (remainingMessages.length === 0) {
                    alert('No messages to export. Please restore some messages before exporting.');
                    exportProgressBar.style.display = 'none';
                    return;
                }
                
                exportProgressFill.style.width = '30%';
                
                // Create new chat text from remaining messages
                let newChatText = '';
                remainingMessages.forEach(msg => {
                    newChatText += msg.originalLine + '\n';
                });
                
                exportProgressFill.style.width = '50%';
                
                // Create a new ZIP file
                const newZip = new JSZip();
                
                // Add the cleaned chat file
                newZip.file(state.chatFileName, newChatText);
                
                exportProgressFill.style.width = '70%';
                
                // Add media files that belong to remaining messages
                const addedMedia = new Set();
                for (const msg of remainingMessages) {
                    if (msg.mediaFilename && state.mediaFiles.has(msg.mediaFilename)) {
                        // Avoid adding duplicates
                        if (!addedMedia.has(msg.mediaFilename)) {
                            newZip.file(msg.mediaFilename, state.mediaFiles.get(msg.mediaFilename));
                            addedMedia.add(msg.mediaFilename);
                        }
                    }
                }
                
                exportProgressFill.style.width = '90%';
                
                // Generate the ZIP file
                const zipBlob = await newZip.generateAsync({ type: 'blob' });
                
                exportProgressFill.style.width = '100%';
                
                // Download the file
                saveAs(zipBlob, `whatsapp_cleaned_${new Date().getTime()}.zip`);
                
                // Hide progress bar after a delay
                setTimeout(() => {
                    exportProgressBar.style.display = 'none';
                    exportProgressFill.style.width = '0%';
                }, 1000);
                
            } catch (error) {
                console.error('Error exporting ZIP:', error);
                alert('Error creating the cleaned ZIP file.');
                exportProgressBar.style.display = 'none';
            }
        }
    </script>
</body>
</html>
